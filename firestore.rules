rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si el usuario es miembro de la organización
    function isMember(orgId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }
    
    // Obtener rol del usuario en la organización
    function getMemberRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role;
    }
    
    // Verificar si el usuario tiene un rol específico
    function hasRole(orgId, roles) {
      return isMember(orgId) && getMemberRole(orgId) in roles;
    }
    
    // Verificar si es owner o admin
    function isAdminOrOwner(orgId) {
      return hasRole(orgId, ['owner', 'admin']);
    }
    
    // Verificar si puede escribir (owner, admin, operator)
    function canWrite(orgId) {
      return hasRole(orgId, ['owner', 'admin', 'operator']);
    }
    
    // ============================================
    // COLECCIÓN: users
    // Documento global de usuario (lookup por userId)
    // ============================================
    match /users/{userId} {
      // Cada usuario puede leer/crear su propio documento
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Solo puede actualizar ciertos campos
      allow update: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // COLECCIÓN: organizations
    // ============================================
    match /organizations/{orgId} {
      // Cualquier usuario autenticado puede crear una organización
      allow create: if isAuthenticated();
      
      // Solo miembros pueden leer la organización
      allow read: if isMember(orgId);
      
      // Solo owner/admin pueden actualizar
      allow update: if isAdminOrOwner(orgId);
      
      // Solo owner puede eliminar (no recomendado)
      allow delete: if hasRole(orgId, ['owner']);
      
      // ----------------------------------------
      // SUBCOLECCIÓN: members
      // Miembros de la organización
      // ----------------------------------------
      match /members/{memberId} {
        // Miembros pueden ver otros miembros
        allow read: if isMember(orgId);
        
        // Solo owner/admin pueden agregar miembros
        // Excepción: el creador puede agregarse a sí mismo
        allow create: if isAuthenticated() && 
          (request.auth.uid == memberId || isAdminOrOwner(orgId));
        
        // Solo owner/admin pueden actualizar roles
        allow update: if isAdminOrOwner(orgId);
        
        // Solo owner puede eliminar miembros (excepto a sí mismo)
        allow delete: if hasRole(orgId, ['owner']) && 
          request.auth.uid != memberId;
      }
      
      // ----------------------------------------
      // SUBCOLECCIÓN: campos (LEGACY)
      // Campos de la organización
      // ----------------------------------------
      match /campos/{campoId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
        
        // Lotes dentro de campos
        match /lotes/{loteId} {
          allow read: if isMember(orgId);
          allow create, update: if canWrite(orgId);
          allow delete: if isAdminOrOwner(orgId);
        }
      }
      
      // ----------------------------------------
      // COLECCIÓN: fields (Campos - Nueva estructura)
      // ----------------------------------------
      match /fields/{fieldId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // COLECCIÓN: plots (Lotes - Nueva estructura)
      // ----------------------------------------
      match /plots/{plotId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // COLECCIÓN: crops (Cultivos/Campañas)
      // ----------------------------------------
      match /crops/{cropId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // SUBCOLECCIÓN: campanias (LEGACY)
      // Campañas agrícolas
      // ----------------------------------------
      match /campanias/{campaniaId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // SUBCOLECCIÓN: eventos
      // Eventos de lotes
      // ----------------------------------------
      match /eventos/{eventoId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // SUBCOLECCIÓN: documentos
      // Documentos y evidencias
      // ----------------------------------------
      match /documentos/{documentoId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // SUBCOLECCIÓN: analisis (LEGACY)
      // Análisis de IA
      // ----------------------------------------
      match /analisis/{analisisId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // COLECCIÓN: satellite_images
      // Imágenes satelitales crudas
      // ----------------------------------------
      match /satellite_images/{imageId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // COLECCIÓN: satellite_analysis
      // Resultados procesados de análisis satelital
      // ----------------------------------------
      match /satellite_analysis/{analysisId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // COLECCIÓN: alerts
      // Alertas para el agricultor
      // ----------------------------------------
      match /alerts/{alertId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // COLECCIÓN: reports
      // Informes generados
      // ----------------------------------------
      match /reports/{reportId} {
        allow read: if isMember(orgId);
        allow create, update: if canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // =========================================================
      // COLECCIONES CONTABLES (Fase 4)
      // =========================================================

      match /accounts/{accountId} {
        allow read: if isMember(orgId);
        allow write: if isMember(orgId) && canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }

      match /journal_entries/{entryId} {
        allow read: if isMember(orgId);
        allow write: if isMember(orgId) && canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }

      match /products/{productId} {
        allow read: if isMember(orgId);
        allow write: if isMember(orgId) && canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }

      match /stock_movements/{movementId} {
        allow read: if isMember(orgId);
        allow write: if isMember(orgId) && canWrite(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ----------------------------------------
      // SUBCOLECCIÓN: invitations
      // Invitaciones pendientes
      // ----------------------------------------
      match /invitations/{invitationId} {
        allow read: if isMember(orgId);
        allow create: if isAdminOrOwner(orgId);
        allow update: if isAdminOrOwner(orgId);
        allow delete: if isAdminOrOwner(orgId);
      }
    }
    
    // ============================================
    // COLECCIÓN LEGACY: agro_productores
    // Para compatibilidad con datos existentes
    // ============================================
    match /agro_productores/{productorId} {
      // El productor puede leer/escribir su propio documento
      allow read, write: if isAuthenticated() && request.auth.uid == productorId;
      
      // Subcolecciones del productor (campos, lotes, etc.)
      match /{subcollection}/{docId} {
        allow read, write: if isAuthenticated() && request.auth.uid == productorId;
        
        match /{nestedCollection}/{nestedDocId} {
          allow read, write: if isAuthenticated() && request.auth.uid == productorId;
        }
      }
    }
  }
}
